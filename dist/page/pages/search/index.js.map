{"version":3,"sources":["../../../../page/pages/search/index.js"],"names":["ctx","Page","data","key","hotList","searchList","history","index","hasMore","isShowNoMoreText","isShowLoadText","undefined","timeId","onShow","wx","setNavigationBarTitle","title","setNavigationBarColor","frontColor","backgroundColor","getStorageSync","setData","length","loadMore","setTimeout","search","pageIndex","then","total","res","pdtcount","concat","productlist","console","log","err","throttle","handleKey","e","detail","value","onKeyChanged","switchPage","dataset","currentTarget","item","id","name","inArray","unshift","splice","setStorage","navigateTo","url","clearHistory"],"mappings":"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","file":"index.js","sourcesContent":["import product from '../../../model/product';\nimport Utils from '../../../util/utils';\nlet ctx;\nPage({\n  data: {\n    key: '',\n    hotList: [],\n    searchList: [],\n    history: [],\n    index: 0,\n    hasMore: true,\n    isShowNoMoreText: false,\n    isShowLoadText: undefined,\n    timeId: null\n  },\n\n  onShow () {\n    ctx = this;\n    wx.setNavigationBarTitle({\n      title: '搜索'\n    });\n    wx.setNavigationBarColor({\n      frontColor: '#000000',\n      backgroundColor: '#ffffff'\n    });\n    let history = wx.getStorageSync('search');\n    let hotList = wx.getStorageSync('hotList');\n    ctx.setData({\n      history: history.length ? history : [],\n      hotList: hotList.length ? hotList : []\n    });\n  },\n\n  loadMore () {\n    if (!ctx.data.hasMore) {\n      ctx.setData({\n        isShowNoMoreText: true\n      });\n      setTimeout(() => {\n        ctx.setData({\n          isShowNoMoreText: false\n        });\n      }, 2000);\n      return;\n    }\n    if (!ctx.data.key.length) return;\n    let index = ++ctx.data.index;\n    let searchList = ctx.data.searchList;\n    ctx.setData({\n      isShowLoadText: true\n    });\n    product.search({\n      key: ctx.data.key,\n      pageIndex: index\n    }).then(res => {\n      let total = res.pdtcount;\n      searchList = searchList.concat(res.productlist);\n      let hasMore = total > searchList.length;\n      ctx.setData({\n        hasMore,\n        searchList,\n        isShowLoadText: false\n      })\n    }, err => {\n      console.log(err);\n    })\n  },\n\n  throttle: Utils.throttle(() => {\n    ctx.setData({\n      searchList: [],\n      index: 0,\n      hasMore: true,\n      isShowNoMoreText: false,\n      isShowLoadText: undefined\n    });\n    ctx.loadMore();\n  }, 300),\n\n  handleKey (e) {\n    ctx.setData({\n      key: e.detail.value\n    });\n    ctx.onKeyChanged();\n  },\n\n  onKeyChanged () {\n    ctx.throttle()\n  },\n\n  switchPage (e) {\n    let dataset = e.currentTarget.dataset;\n    let history = ctx.data.history;\n    if (dataset.log) {\n      let item = {\n        id: dataset.id,\n        name: dataset.name,\n      };\n      let inArray = Utils.inArray(history, item, 'id');\n      if (!inArray) {\n        history.unshift(item);\n        history = history.splice(0, 10);\n        wx.setStorage({\n          key: 'search',\n          data: history\n        });\n        ctx.setData({\n          history\n        })\n      }\n    }\n    wx.navigateTo({\n      url: dataset.url\n    })\n  },\n\n  clearHistory () {\n    ctx.setData({\n      history: []\n    });\n    wx.setStorage({\n      key: 'search',\n      data: []\n    })\n  }\n});"]}