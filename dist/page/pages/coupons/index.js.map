{"version":3,"sources":["../../../../page/pages/coupons/index.js"],"names":["ctx","app","getApp","Page","data","menuIndex","left","unUsedCoupon","usedCoupon","outTimeCoupon","menuList","text","length","token","couponList","onShow","wx","setNavigationBarTitle","title","setNavigationBarColor","frontColor","backgroundColor","userInfo","getUserInfo","setData","loadCoupons","curTime","curTimeStamp","page","uid","us_uid","userkey","then","cps","map","timeObj","formatDate","parseInt","item","invalidTime","deadline","Y","M","D","value","faceValue","status","push","sortByKey","console","log","err","setLeft","handleMenu","e","dataset","currentTarget","index","handleToken","detail","addCoupon","add","showToast","showModal","content","showCancel"],"mappings":"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","file":"index.js","sourcesContent":["import Utils from '../../../util/utils';\nimport coupon from '../../../model/coupon';\nimport user from '../../../model/user';\nlet ctx, app = getApp();\n\nPage({\n\n  data: {\n    menuIndex: 0,\n    left: 0,\n    unUsedCoupon: [],\n    usedCoupon: [],\n    outTimeCoupon: [],\n    menuList: [{\n      text: '未使用',\n      length: 2\n    }, {\n      text: '已使用',\n      length: 2\n    }, {\n      text: '已过期',\n      length: 2\n    }],\n    token: '',\n    couponList: []\n  },\n\n  onShow () {\n    ctx = this;\n    wx.setNavigationBarTitle({\n      title: '我的优惠券'\n    });\n    wx.setNavigationBarColor({\n      frontColor: '#000000',\n      backgroundColor: '#ffffff'\n    });\n    let userInfo = user.getUserInfo();\n    ctx.setData({\n      userInfo\n    });\n    ctx.loadCoupons();\n  },\n\n  loadCoupons () {\n    let userInfo = ctx.data.userInfo;\n    let unUsedCoupon = [];\n    let usedCoupon = [];\n    let outTimeCoupon = [];\n    let curTime = Utils.curTimeStamp();\n    let menuList = ctx.data.menuList;\n    coupon.page({\n      uid: userInfo.us_uid,\n      userkey: userInfo.userkey\n    }).then(cps => {\n      cps = cps.map(item => {\n        let timeObj = Utils.formatDate(parseInt(item.invalidTime) * 1000);\n        item.deadline = `${timeObj.Y}-${timeObj.M}-${timeObj.D}`;\n        item.value = parseInt(item.faceValue) / 1000;\n        return item;\n      });\n      cps.map(item => {\n        if (item.status != 10) {\n          // 已经使用\n          usedCoupon.push(item);\n        } else if ((parseInt(item.invalidTime) * 1000) < curTime) {\n          // 已经过期\n          outTimeCoupon.push(item);\n        } else {\n          unUsedCoupon.push(item);\n        }\n      });\n      menuList[0]['data'] = unUsedCoupon;\n      menuList[1]['data'] = usedCoupon;\n      menuList[2]['data'] = outTimeCoupon;\n      Utils.sortByKey(cps, 'value');\n      ctx.setData({\n        couponList: cps,\n        usedCoupon,\n        unUsedCoupon,\n        outTimeCoupon,\n        menuList\n      })\n    }, err => {\n      console.log(err);\n    });\n  },\n\n  setLeft () {\n    let left = (ctx.data.menuIndex / 3) * 100;\n    ctx.setData({\n      left\n    })\n  },\n\n  handleMenu(e) {\n    let dataset = e.currentTarget.dataset;\n    console.log(dataset);\n    ctx.setData({\n      menuIndex: dataset.index\n    })\n  },\n\n  handleToken (e) {\n    ctx.setData({\n      token: e.detail.value\n    })\n  },\n\n  addCoupon () {\n    coupon.add({\n      token: ctx.data.token,\n      uid: ctx.data.userInfo.us_uid\n    }).then(res => {\n      wx.showToast({\n        title: '添加成功'\n      });\n      ctx.loadCoupons();\n    }, err => {\n      wx.showModal({\n        title: '提示',\n        content: err,\n        showCancel: false\n      })\n    })\n  }\n});"]}