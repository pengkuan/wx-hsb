{"version":3,"sources":["../../../../page/pages/bind/index.js"],"names":["ctx","timeId","app","getApp","Page","data","type","tel","code","openid","unionid","isValidTel","counter","onShow","params","getCurPageOpt","getUserInfo","title","wx","setNavigationBarTitle","setWhiteNavBar","wxToken","getWxToken","setData","length","Object","keys","getWxCode","then","getWxOpenId","setWxToken","getCode","counting","showInfo","icon","retcode","retinfo","showToast","setTimeout","handleTel","e","detail","value","handleCode","clearTel","unbindTel","userInfo","console","log","authUserUnbindTel","uid","us_uid","userkey","setUserInfo","reLaunch","url","success","err","fail","submit","bindTelLogin","navigateBack","delta"],"mappings":";;AAAA;;;;AACA;;;;;;AACA,IAAIA,YAAJ;AAAA,IAASC,eAAT;AAAA,IAAiBC,MAAMC,QAAvB;;AAEAC,KAAK;;AAEHC,QAAM;AACJC,UAAM,MADF;AAEJC,SAAK,EAFD;AAGJC,UAAM,EAHF;AAIJC,YAAQ,EAJJ;AAKJC,aAAS,EALL;AAMJC,gBAAY,KANR;AAOJC,aAAS,CAPL,CAOO;AAPP,GAFH;;AAYHC,QAZG,oBAYO;AACR,QAAIC,SAAS,gBAAMC,aAAN,EAAb;AACAf,UAAM,IAAN;AACA,QAAIO,MAAM,eAAKS,WAAL,GAAmBT,GAA7B;AACA,QAAIU,QAAQH,OAAOR,IAAP,KAAgB,MAAhB,GAAyB,MAAzB,GAAkC,MAA9C;AACAY,OAAGC,qBAAH,CAAyB;AACvBF;AADuB,KAAzB;AAGA,oBAAMG,cAAN;AACA;AACA,QAAIC,UAAU,eAAKC,UAAL,EAAd;AACAtB,QAAIuB,OAAJ,CAAY;AACVjB,YAAMQ,OAAOR,IADH;AAEVC,WAAKA,MAAMA,GAAN,GAAY,EAFP;AAGVE,cAAQY,QAAQZ,MAHN;AAIVC,eAASW,QAAQX,OAJP;AAKVC,kBAAYJ,OAAOA,IAAIiB,MAAJ,KAAe;AALxB,KAAZ;AAOA,QAAIC,OAAOC,IAAP,CAAYL,OAAZ,EAAqBG,MAArB,KAAgC,CAApC,EAAuC;AACrC,qBAAKG,SAAL,GAAiBC,IAAjB,CAAsB,gBAAQ;AAC5B,uBAAKC,WAAL,CAAiBrB,IAAjB,EAAuBoB,IAAvB,CAA4B,mBAAW;AACrC,yBAAKE,UAAL,CAAgBT,OAAhB;AACArB,cAAIuB,OAAJ,CAAY;AACVd,oBAAQY,QAAQZ,MADN;AAEVC,qBAASW,QAAQX;AAFP,WAAZ;AAID,SAND;AAOD,OARD;AASD;AACF,GAzCE;;;AA2CH;;;;AAIAqB,SA/CG,qBA+CQ;AACT,QAAIxB,MAAMP,IAAIK,IAAJ,CAASE,GAAnB;AACAP,QAAIuB,OAAJ,CAAY;AACVX,eAAS;AADC,KAAZ;AAGAZ,QAAIgC,QAAJ;AACA,mBAAKD,OAAL,CAAa,EAACxB,QAAD,EAAb,EAAoBqB,IAApB,CAAyB,gBAAQ;AAC/B,UAAIK,WAAW;AACbhB,eAAO,IADM;AAEbiB,cAAM;AAFO,OAAf;AAIA,UAAI7B,KAAK8B,OAAL,IAAgB,CAApB,EAAuB;AACrBF,iBAAShB,KAAT,GAAiB,QAAjB;AACAgB,iBAASC,IAAT,GAAgB,SAAhB;AACD,OAHD,MAGO;AACLD,iBAAShB,KAAT,GAAiBZ,KAAK+B,OAAtB;AACD;AACDlB,SAAGmB,SAAH,CAAaJ,QAAb;AACD,KAZD;AAaD,GAlEE;AAoEHD,UApEG,sBAoES;AACV,QAAIpB,UAAUZ,IAAIK,IAAJ,CAASO,OAAvB;AACA,QAAIA,YAAY,CAAhB,EAAmB;AACnBX,aAASqC,WAAW,YAAM;AACxBtC,UAAIuB,OAAJ,CAAY;AACVX,iBAASA,UAAU;AADT,OAAZ;AAGAZ,UAAIgC,QAAJ;AACD,KALQ,EAKN,IALM,CAAT;AAMD,GA7EE;AA+EHO,WA/EG,qBA+EQC,CA/ER,EA+EW;AACZ,QAAIjC,MAAMiC,EAAEC,MAAF,CAASC,KAAnB;AACA,SAAKnB,OAAL,CAAa;AACXhB,cADW;AAEXI,kBAAYJ,OAAOA,IAAIiB,MAAJ,KAAe;AAFvB,KAAb;AAID,GArFE;AAuFHmB,YAvFG,sBAuFSH,CAvFT,EAuFY;AACb,QAAIE,QAAQF,EAAEC,MAAF,CAASC,KAArB;AACA,SAAKnB,OAAL,CAAa;AACXf,YAAMkC;AADK,KAAb;AAGD,GA5FE;AA8FHE,UA9FG,sBA8FS;AACV5C,QAAIuB,OAAJ,CAAY;AACVhB,WAAK,EADK;AAEVI,kBAAY,KAFF;AAGVH,YAAM;AAHI,KAAZ;AAKD,GApGE;;;AAsGH;;;;AAIAqC,WA1GG,uBA0GU;AACX,QAAIxC,OAAOL,IAAIK,IAAf;AACA,QAAIyC,WAAW,eAAK9B,WAAL,EAAf;AACA+B,YAAQC,GAAR,CAAYF,QAAZ;AACA,mBAAKG,iBAAL,CAAuB;AACrBC,WAAKJ,SAASK,MADO;AAErBC,eAASN,SAASM,OAFG;AAGrB3C,cAAQJ,KAAKI;AAHQ,KAAvB,EAIGmB,IAJH,CAIQ,eAAO;AACb;AACA,qBAAKyB,WAAL,CAAiB,EAAjB;AACAnC,SAAGoC,QAAH,CAAY;AACVC,aAAK,iBADK;AAEVC,eAFU,mBAEDC,GAFC,EAEI;AACZV,kBAAQC,GAAR,CAAYS,GAAZ;AACD,SAJS;AAKVC,YALU,gBAKJD,GALI,EAKC;AACTV,kBAAQC,GAAR,CAAYS,GAAZ;AACD;AAPS,OAAZ;AASD,KAhBD;AAiBD,GA/HE;;;AAiIH;AACAE,QAlIG,oBAkIO;AACR,QAAItD,OAAOL,IAAIK,IAAf;AACA,QAAIA,KAAKC,IAAL,IAAa,MAAjB,EAAyBN,IAAI4D,YAAJ;AACzB,QAAIvD,KAAKC,IAAL,IAAa,QAAjB,EAA2BN,IAAI6C,SAAJ;AAC5B,GAtIE;;;AAwIH;AACAe,cAzIG,0BAyIa;AACd,QAAIvD,OAAOL,IAAIK,IAAf;AACA,mBAAKuD,YAAL,CAAkB;AAChBrD,WAAKF,KAAKE,GADM;AAEhBC,YAAMH,KAAKG,IAFK;AAGhBC,cAAQJ,KAAKI,MAHG;AAIhBC,eAASL,KAAKK;AAJE,KAAlB,EAKGkB,IALH,CAKQ,gBAAQ;AACd,qBAAKyB,WAAL,CAAiBhD,IAAjB;AACAa,SAAG2C,YAAH,CAAgB;AACdC,eAAO;AADO,OAAhB;AAGD,KAVD,EAUG,eAAO;AACR5C,SAAGmB,SAAH,CAAa;AACXpB,eAAOwC;AADI,OAAb;AAGD,KAdD;AAeD;AA1JE,CAAL","file":"index.js","sourcesContent":["import user from '../../../model/user';\nimport Utils from '../../../util/utils';\nlet ctx, timeId, app = getApp();\n\nPage({\n\n  data: {\n    type: 'bind',\n    tel: '',\n    code: \"\",\n    openid: \"\",\n    unionid: \"\",\n    isValidTel: false,\n    counter: 0 // 默认只需等待0秒\n  },\n\n  onShow () {\n    let params = Utils.getCurPageOpt();\n    ctx = this;\n    let tel = user.getUserInfo().tel;\n    let title = params.type === 'bind' ? '绑定手机' : '解绑手机';\n    wx.setNavigationBarTitle({\n      title,\n    });\n    Utils.setWhiteNavBar();\n    // 有可能没有token 比如直接编译当前页面\n    let wxToken = user.getWxToken();\n    ctx.setData({\n      type: params.type,\n      tel: tel ? tel : '',\n      openid: wxToken.openid,\n      unionid: wxToken.unionid,\n      isValidTel: tel && tel.length === 11\n    });\n    if (Object.keys(wxToken).length === 0) {\n      user.getWxCode().then(code => {\n        user.getWxOpenId(code).then(wxToken => {\n          user.setWxToken(wxToken);\n          ctx.setData({\n            openid: wxToken.openid,\n            unionid: wxToken.unionid\n          });\n        })\n      })\n    }\n  },\n\n  /**\n   * 获取短信验证码\n   * tel 已经校验过了\n   */\n  getCode () {\n    let tel = ctx.data.tel;\n    ctx.setData({\n      counter: 30\n    });\n    ctx.counting();\n    user.getCode({tel}).then(data => {\n      let showInfo = {\n        title: '提示',\n        icon: 'loading',\n      };\n      if (data.retcode == 0) {\n        showInfo.title = \"发送短信成功\";\n        showInfo.icon = 'success'\n      } else {\n        showInfo.title = data.retinfo;\n      }\n      wx.showToast(showInfo);\n    })\n  },\n\n  counting () {\n    let counter = ctx.data.counter;\n    if (counter === 0) return;\n    timeId = setTimeout(() => {\n      ctx.setData({\n        counter: counter - 1\n      });\n      ctx.counting();\n    }, 1000)\n  },\n\n  handleTel (e) {\n    let tel = e.detail.value;\n    this.setData({\n      tel,\n      isValidTel: tel && tel.length === 11\n    })\n  },\n\n  handleCode (e) {\n    let value = e.detail.value;\n    this.setData({\n      code: value\n    })\n  },\n\n  clearTel () {\n    ctx.setData({\n      tel: '',\n      isValidTel: false,\n      code: ''\n    })\n  },\n\n  /**\n   * 解绑手机号\n   * 需用用户登录\n   */\n  unbindTel () {\n    let data = ctx.data;\n    let userInfo = user.getUserInfo();\n    console.log(userInfo);\n    user.authUserUnbindTel({\n      uid: userInfo.us_uid,\n      userkey: userInfo.userkey,\n      openid: data.openid\n    }).then(res => {\n      // 解绑成功清除回收宝账户信息\n      user.setUserInfo({});\n      wx.reLaunch({\n        url: '../person/index',\n        success (err) {\n          console.log(err)\n        },\n        fail (err) {\n          console.log(err)\n        }\n      });\n    })\n  },\n\n  // 绑定手机号\n  submit () {\n    let data = ctx.data;\n    if (data.type == 'bind') ctx.bindTelLogin();\n    if (data.type == 'unbind') ctx.unbindTel()\n  },\n\n  // 绑定手机号\n  bindTelLogin () {\n    let data = ctx.data;\n    user.bindTelLogin({\n      tel: data.tel,\n      code: data.code,\n      openid: data.openid,\n      unionid: data.unionid,\n    }).then(data => {\n      user.setUserInfo(data);\n      wx.navigateBack({\n        delta: 1\n      });\n    }, err => {\n      wx.showToast({\n        title: err\n      })\n    })\n  },\n});"]}